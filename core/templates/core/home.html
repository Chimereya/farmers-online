{% extends "base.html" %}

{% block content %}

<main class="container">
   <section class="categories mb-6">
    {% for category in categories %}
      <a class="category-link button outline round-full" href="{% url 'category' category.slug %}">{{ category.name }}</a>
      {% endfor %}
   </section>

   <section>
    <h2>All Products</h2>
    <div class="all-products">
        {% for product in products %}
       <div class="product-card round-md">
        <img class="round-md" src="{{ product.product_image.url}}" alt="{{ product.title }}">
        
            <a href="{{ product.get_absolute_url }}">{{ product.title }}</a>
            
                <p>
                    {% if product.discount_price %}
                      <span><del>${{ product.price }}</del></span>
                      <span>{{ product.discount_price}}</span>
                      {% else %}
                    <span>{{ product.price}}</span>
                    {% endif %}
                    <form id="add-to-cart-form" action="{% url 'add_to_cart' product.id %}" method="post">
                      {% csrf_token %}
                      <button class="button primary sm" type="submit">Add to Cart</button>
                  </form>
       </div>
       {% endfor %}
    </div>
   </section>
</main>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
  $(document).ready(function() {
      $('#add-to-cart-form').submit(function(event) {
          event.preventDefault();
          var form = $(this);
          var url = form.attr('action');
  
          $.ajax({
              url: url,
              method: 'POST',
              data: form.serialize(),
              success: function(data) {
                  if (data.success) {
                      $('#cart-message').text(data.message).css('color', 'green');
                      $('#cart-length').text(data.total_items);
                  } else {
                      $('#cart-message').text(data.message).css('color', 'red');
                  }
              },
              error: function(xhr, errmsg, err) {
                  console.log(xhr.status + ": " + xhr.responseText);
              }
          });
      });
  });
</script>
{% endblock content %}